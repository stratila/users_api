steps:
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '--target', 'production', '--tag', 'gcr.io/$PROJECT_ID/users_api:$COMMIT_SHA', '.' ]
- name: 'gcr.io/cloud-builders/docker'
  args: ['compose', '-f', 'docker-compose.yaml', 'up', '--detach']
- name: 'gcr.io/cloud-builders/docker'
  args: ['compose', '-f', 'docker-compose.yaml', 'exec', '--no-TTY', '--workdir', '/tests', 'web', '/bin/sh', '-c', '/scripts/migrate.sh; python3 -m pytest -vvv']
- name: 'gcr.io/cloud-builders/docker'
  args: ['compose', '-f', 'docker-compose.yaml', 'down' ]
  
images: ['gcr.io/$PROJECT_ID/users_api:$COMMIT_SHA']

options:
  machineType: 'N1_HIGHCPU_8'