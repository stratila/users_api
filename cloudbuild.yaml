steps:
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '--target', '"production"', '--tag', 'gcr.io/$PROJECT_ID/my-image:$COMMIT_SHA', '.' ]
- name: 'gcr.io/cloud-builders/docker'
  args: ['compose', '-f', 'docker-compose.yaml', 'up', '--detach']
- name: 'gcr.io/cloud-builders/docker'
  args: ['compose', '-f', 'docker-compose.yaml', 'exec', '--no-TTY', '--workdir', '/tests', 'web', '/bin/sh', '-c', '/scripts/migrate.sh; python3 -m pytest -vvv']
- name: 'gcr.io/cloud-builders/docker'
  args: ['compose', '-f', 'docker-compose.yaml', 'down' ]
  

#- name: 'gcr.io/cloud-builders/docker'
#  args: [ 'push', 'gcr.io/$PROJECT_ID/my-image:$COMMIT_SHA' ]
#images:
#- 'gcr.io/$PROJECT_ID/my-image:$COMMIT_SHA'